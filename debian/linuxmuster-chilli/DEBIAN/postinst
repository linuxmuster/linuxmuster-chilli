#!/bin/bash


# Source debconf library.
. /usr/share/debconf/confmodule

db_version 2.0


db_get linuxmuster-chilli/ldap-server
if [ "$RET" ]; then
    LDAP_SERVER=$RET;
fi

db_get linuxmuster-chilli/base-dn
if [ "$RET" ]; then
    BASEDN=$RET;
fi

db_get linuxmuster-chilli/ldap-pass
if [ "$RET" ]; then
    LDAP_PASS=$RET;
fi

SHARED_SECRET=`pwgen -s -n 20`

echo "BASE DN: $BASEDN"
echo "LDAP SERVER: $LDAP_SERVER"
echo "LDAP_PASS: $LDAP_PASS"
echo "SHARED_SECRET: $SHARED_SECRET"


# patching configuration files
echo "Patching configuration ..."
cd /var/lib/linuxmuster-chilli/tpl

find -type f | xargs -i -t sh -c \
    "sed -e    's%@@ldap_server@@%${LDAP_SERVER}%g
                s%@@ldap_pass@@%${LDAP_PASS}%g
                s%@@basedn@@%${BASEDN}%g
                s%@@shared_secret@@%${SHARED_SECRET}%g
                s%@@serverip@@%${serverip}%g' {} > /{}" 2> /dev/null 1> /dev/null

# ensure the permissions are correct
chown root.freerad /etc/freeradius/clients.conf
chmod 640 /etc/freeradius/clients.conf

/etc/init.d/freeradius restart


# dh_installdeb will replace this with shell code automatically

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



db_stop

exit 0
